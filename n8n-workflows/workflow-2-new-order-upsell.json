{
  "name": "New Order Upsell + Lookalike Generation",
  "nodes": [
    {
      "parameters": {
        "triggerOn": "webhook",
        "path": "new-order",
        "httpMethod": "POST"
      },
      "id": "trigger-new-order",
      "name": "Webhook - New Order",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@gmail.com"
            },
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@yahoo.com"
            },
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@hotmail.com"
            }
          ]
        }
      },
      "id": "check-corporate-email",
      "name": "Check Corporate Email",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.apollo.io/v1/people/match",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "X-Api-Key", "value": "D2fPk6LElk4FnK7PAVSx3g"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { email: $json.email } }}",
        "options": {"waitBetweenItems": 600}
      },
      "id": "apollo-enrich",
      "name": "Apollo Enrich Person",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 200]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/orders",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Authorization", "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Content-Type", "value": "application/json"},
            {"name": "Prefer", "value": "return=representation"}
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [{"name": "id", "value": "=eq.{{ $json.id }}"}]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  job_title: $json.person?.title,\n  company_name: $json.person?.organization?.name,\n  company_size: $json.person?.organization?.estimated_num_employees\n} }}"
      },
      "id": "update-order",
      "name": "Update Order with Enrichment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.apollo.io/v1/mixed_people/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "X-Api-Key", "value": "D2fPk6LElk4FnK7PAVSx3g"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  organization_name: $json.person?.organization?.name,\n  person_titles: [$json.person?.title],\n  per_page: 15\n} }}",
        "options": {"waitBetweenItems": 600}
      },
      "id": "search-lookalikes",
      "name": "Search Apollo Lookalikes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/expansion_opportunities",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Authorization", "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.people?.map(p => ({\n  company_name: p.organization?.name || '',\n  existing_customer_email: $('trigger-new-order').item.json.email,\n  prospect_email: p.email,\n  prospect_name: p.name,\n  prospect_title: p.title,\n  prospect_seniority: p.seniority,\n  prospect_linkedin: p.linkedin_url,\n  company_size: p.organization?.estimated_num_employees,\n  source: 'customer_lookalike',\n  opportunity_type: 'colleague',\n  created_at: new Date().toISOString()\n})) }}"
      },
      "id": "save-lookalikes",
      "name": "Save Lookalikes to DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "amount": 30,
        "unit": "days"
      },
      "id": "wait-30-days",
      "name": "Wait 30 Days",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "sendGridApi",
        "fromEmail": "noreply@agile36.com",
        "toEmail": "={{ $('trigger-new-order').item.json.email }}",
        "subject": "Ready for your next certification?",
        "text": "Hi {{ $('trigger-new-order').item.json.name }}, Congrats on completing {{ $('trigger-new-order').item.json.course_name }}! Ready to level up? Get {{ $('trigger-new-order').item.json.next_recommended_course }} with $150 OFF: Code 150OFF. Enroll here: {{ $('trigger-new-order').item.json.course_link }}"
      },
      "id": "send-upsell-email",
      "name": "Send Upsell Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/orders",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Authorization", "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [{"name": "id", "value": "=eq.{{ $('trigger-new-order').item.json.id }}"}]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { upsell_offered: true, upsell_offered_at: new Date().toISOString() } }}"
      },
      "id": "update-upsell-status",
      "name": "Update Upsell Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/outreach_log",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Authorization", "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  source_table: 'orders',\n  source_id: $('trigger-new-order').item.json.id,\n  email: $('trigger-new-order').item.json.email,\n  workflow_name: 'New Order Upsell',\n  channel: 'email',\n  subject: 'Ready for your next certification?',\n  status: 'sent',\n  sent_at: new Date().toISOString()\n} }}"
      },
      "id": "log-outreach",
      "name": "Log to Outreach Log",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2050, 200]
    }
  ],
  "connections": {
    "Webhook - New Order": {
      "main": [[{"node": "Check Corporate Email", "type": "main", "index": 0}]]
    },
    "Check Corporate Email": {
      "main": [
        [{"node": "Apollo Enrich Person", "type": "main", "index": 0}],
        []
      ]
    },
    "Apollo Enrich Person": {
      "main": [[{"node": "Update Order with Enrichment", "type": "main", "index": 0}]]
    },
    "Update Order with Enrichment": {
      "main": [[{"node": "Search Apollo Lookalikes", "type": "main", "index": 0}]]
    },
    "Search Apollo Lookalikes": {
      "main": [[{"node": "Save Lookalikes to DB", "type": "main", "index": 0}]]
    },
    "Save Lookalikes to DB": {
      "main": [[{"node": "Wait 30 Days", "type": "main", "index": 0}]]
    },
    "Wait 30 Days": {
      "main": [[{"node": "Send Upsell Email", "type": "main", "index": 0}]]
    },
    "Send Upsell Email": {
      "main": [[{"node": "Update Upsell Status", "type": "main", "index": 0}]]
    },
    "Update Upsell Status": {
      "main": [[{"node": "Log to Outreach Log", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {"executionOrder": "v1"},
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-19T00:00:00.000Z",
  "versionId": "1"
}
