{
  "name": "Abandoned Checkout Recovery + Lookalike Generation",
  "nodes": [
    {
      "parameters": {
        "triggerOn": "webhook",
        "path": "enrollment-leads",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "trigger-enrollment-lead",
      "name": "Webhook - New Enrollment Lead",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "enrollment-leads"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@gmail.com"
            },
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@yahoo.com"
            },
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@hotmail.com"
            },
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@outlook.com"
            },
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@aol.com"
            }
          ]
        }
      },
      "id": "check-corporate-email",
      "name": "Check Corporate Email",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.apollo.io/v1/people/match",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Api-Key",
              "value": "D2fPk6LElk4FnK7PAVSx3g"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "email",
              "value": "={{ $json.email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "apollo-enrich-person",
      "name": "Apollo Enrich Person",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 200],
      "notes": "Enrich person data from Apollo API"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/enrollment_leads",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "=eq.{{ $('trigger-enrollment-lead').item.json.id }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  job_title: $json.person?.title,\n  company_name: $json.person?.organization?.name,\n  company_size: $json.person?.organization?.estimated_num_employees,\n  seniority: $json.person?.seniority,\n  linkedin_url: $json.person?.linkedin_url,\n  phone_number: $json.person?.phone_numbers?.[0]?.raw_number,\n  enriched_at: new Date().toISOString()\n} }}",
        "options": {}
      },
      "id": "update-enrollment-lead",
      "name": "Update Enrollment Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "director-check",
              "leftValue": "={{ $json.person?.seniority }}",
              "rightValue": "director",
              "operator": {
                "type": "string",
                "operation": "contains",
                "singleValue": true
              }
            },
            {
              "id": "size-check",
              "leftValue": "={{ $json.person?.organization?.estimated_num_employees }}",
              "rightValue": 1000,
              "operator": {
                "type": "number",
                "operation": "largerEqual",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-high-priority",
      "name": "Check High Priority (Director+ & 1000+)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SLACK_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  text: `URGENT: ${$('trigger-enrollment-lead').item.json.name} (${$json.person?.title} at ${$json.person?.organization?.name}) abandoned $${$('trigger-enrollment-lead').item.json.cart_value} checkout - ${$json.person?.linkedin_url}`\n} }}",
        "options": {}
      },
      "id": "send-slack-alert",
      "name": "Send Slack Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.apollo.io/v1/mixed_people/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Api-Key",
              "value": "D2fPk6LElk4FnK7PAVSx3g"
            },
            "Content-Type",
            "application/json"
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  organization_name: $json.person?.organization?.name,\n  person_titles: [$json.person?.title],\n  q_keywords: $json.person?.departments?.join(' '),\n  per_page: 20\n} }}",
        "options": {
          "waitBetweenItems": 600
        }
      },
      "id": "search-apollo-lookalikes",
      "name": "Search Apollo Lookalikes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/expansion_opportunities",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.people?.map(p => ({\n  company_name: p.organization?.name || '',\n  existing_customer_email: $('trigger-enrollment-lead').item.json.email,\n  prospect_email: p.email,\n  prospect_name: p.name,\n  prospect_first_name: p.first_name,\n  prospect_last_name: p.last_name,\n  prospect_title: p.title,\n  prospect_seniority: p.seniority,\n  prospect_linkedin: p.linkedin_url,\n  prospect_phone: p.phone_numbers?.[0]?.raw_number,\n  company_size: p.organization?.estimated_num_employees,\n  company_industry: p.organization?.industry,\n  source: 'abandoned_checkout_lookalike',\n  opportunity_type: 'colleague',\n  created_at: new Date().toISOString()\n})) }}",
        "options": {}
      },
      "id": "save-lookalikes",
      "name": "Save Lookalikes to DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "amount": 1,
        "unit": "hours"
      },
      "id": "wait-1-hour",
      "name": "Wait 1 Hour",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "sendGridApi",
        "fromEmail": "noreply@agile36.com",
        "toEmail": "={{ $('trigger-enrollment-lead').item.json.email }}",
        "subject": "Complete your order - $200 OFF inside",
        "text": "Hi {{ $('trigger-enrollment-lead').item.json.name }}, You started checking out but didn't complete your order. Here's $200 OFF to finish: Code 200OFF. Complete your order: {{ $('trigger-enrollment-lead').item.json.checkout_link }}",
        "options": {}
      },
      "id": "send-email",
      "name": "Send Email via SendGrid",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1250, 400],
      "credentials": {
        "sendGridApi": {
          "id": "sendgrid-credentials",
          "name": "SendGrid API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/outreach_log",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  source_table: 'enrollment_leads',\n  source_id: $('trigger-enrollment-lead').item.json.id,\n  email: $('trigger-enrollment-lead').item.json.email,\n  workflow_name: 'Abandoned Checkout Recovery',\n  channel: 'email',\n  subject: 'Complete your order - $200 OFF inside',\n  body: `Hi ${$('trigger-enrollment-lead').item.json.name}, You started checking out but didn't complete your order. Here's $200 OFF to finish: Code 200OFF. Complete your order: ${$('trigger-enrollment-lead').item.json.checkout_link}`,\n  status: 'sent',\n  sent_at: new Date().toISOString()\n} }}",
        "options": {}
      },
      "id": "log-outreach",
      "name": "Log to Outreach Log",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, message: 'Abandoned checkout recovery workflow completed' } }}"
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 400]
    }
  ],
  "connections": {
    "Webhook - New Enrollment Lead": {
      "main": [[{"node": "Check Corporate Email", "type": "main", "index": 0}]]
    },
    "Check Corporate Email": {
      "main": [
        [{"node": "Apollo Enrich Person", "type": "main", "index": 0}],
        [{"node": "Wait 1 Hour", "type": "main", "index": 0}]
      ]
    },
    "Apollo Enrich Person": {
      "main": [[{"node": "Update Enrollment Lead", "type": "main", "index": 0}]]
    },
    "Update Enrollment Lead": {
      "main": [[{"node": "Check High Priority (Director+ & 1000+)", "type": "main", "index": 0}]]
    },
    "Check High Priority (Director+ & 1000+)": {
      "main": [
        [{"node": "Send Slack Alert", "type": "main", "index": 0}],
        [{"node": "Search Apollo Lookalikes", "type": "main", "index": 0}]
      ]
    },
    "Send Slack Alert": {
      "main": [[{"node": "Search Apollo Lookalikes", "type": "main", "index": 0}]]
    },
    "Search Apollo Lookalikes": {
      "main": [[{"node": "Save Lookalikes to DB", "type": "main", "index": 0}]]
    },
    "Save Lookalikes to DB": {
      "main": [[{"node": "Wait 1 Hour", "type": "main", "index": 0}]]
    },
    "Wait 1 Hour": {
      "main": [[{"node": "Send Email via SendGrid", "type": "main", "index": 0}]]
    },
    "Send Email via SendGrid": {
      "main": [[{"node": "Log to Outreach Log", "type": "main", "index": 0}]]
    },
    "Log to Outreach Log": {
      "main": [[{"node": "Webhook Response", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-19T00:00:00.000Z",
  "versionId": "1"
}
