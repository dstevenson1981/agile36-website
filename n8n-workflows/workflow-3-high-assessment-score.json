{
  "name": "High Assessment Score Follow-up",
  "nodes": [
    {
      "parameters": {
        "triggerOn": "webhook",
        "path": "assessment-emails",
        "httpMethod": "POST"
      },
      "id": "trigger-assessment",
      "name": "Webhook - New Assessment (Score >= 80)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.exam_score }}",
              "operation": "largerEqual",
              "value2": 80
            }
          ]
        }
      },
      "id": "check-score",
      "name": "Check Score >= 80",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@gmail.com"
            },
            {
              "value1": "={{ $json.email }}",
              "operation": "notContains",
              "value2": "@yahoo.com"
            }
          ]
        }
      },
      "id": "check-corporate-email",
      "name": "Check Corporate Email",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.apollo.io/v1/people/match",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "X-Api-Key", "value": "D2fPk6LElk4FnK7PAVSx3g"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { email: $json.email } }}",
        "options": {"waitBetweenItems": 600}
      },
      "id": "apollo-enrich",
      "name": "Apollo Enrich Person",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 100]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/assessment_emails",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Authorization", "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [{"name": "id", "value": "=eq.{{ $('trigger-assessment').item.json.id }}"}]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  job_title: $json.person?.title,\n  company_name: $json.person?.organization?.name,\n  company_size: $json.person?.organization?.estimated_num_employees,\n  seniority: $json.person?.seniority,\n  linkedin_url: $json.person?.linkedin_url\n} }}"
      },
      "id": "update-assessment",
      "name": "Update Assessment with Enrichment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 100]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "combinator": "and"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.person?.seniority }}",
              "rightValue": "director",
              "operator": {"type": "string", "operation": "contains"}
            },
            {
              "leftValue": "={{ $json.person?.organization?.estimated_num_employees }}",
              "rightValue": 500,
              "operator": {"type": "number", "operation": "largerEqual"}
            }
          ]
        }
      },
      "id": "check-hot-lead",
      "name": "Check Hot Lead (Director+ & 500+)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1250, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SLACK_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  text: `HOT LEAD: ${$('trigger-assessment').item.json.name} scored ${$('trigger-assessment').item.json.exam_score}% - ${$json.person?.title} at ${$json.person?.organization?.name} (${$json.person?.organization?.estimated_num_employees} employees) - ${$json.person?.linkedin_url}`\n} }}"
      },
      "id": "send-slack-alert",
      "name": "Send Slack Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.apollo.io/v1/mixed_people/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "X-Api-Key", "value": "D2fPk6LElk4FnK7PAVSx3g"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  organization_name: $json.person?.organization?.name,\n  person_titles: [$json.person?.title],\n  per_page: 10\n} }}",
        "options": {"waitBetweenItems": 600}
      },
      "id": "search-lookalikes",
      "name": "Search Apollo Lookalikes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/expansion_opportunities",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Authorization", "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.people?.map(p => ({\n  company_name: p.organization?.name || '',\n  prospect_email: p.email,\n  prospect_name: p.name,\n  prospect_title: p.title,\n  prospect_seniority: p.seniority,\n  prospect_linkedin: p.linkedin_url,\n  company_size: p.organization?.estimated_num_employees,\n  source: 'assessment_lookalike',\n  opportunity_type: 'colleague',\n  created_at: new Date().toISOString()\n})) }}"
      },
      "id": "save-lookalikes",
      "name": "Save Lookalikes to DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "sendGridApi",
        "fromEmail": "noreply@agile36.com",
        "toEmail": "={{ $('trigger-assessment').item.json.email }}",
        "subject": "Great score! Here's your next step",
        "text": "Hi {{ $('trigger-assessment').item.json.name }}, You scored {{ $('trigger-assessment').item.json.exam_score }}% on the practice exam - great work! Ready to get certified? View courses: {{ $('trigger-assessment').item.json.course_catalog_link }}"
      },
      "id": "send-email",
      "name": "Send Email via SendGrid",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/outreach_log",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Authorization", "value": "Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  source_table: 'assessment_emails',\n  source_id: $('trigger-assessment').item.json.id,\n  email: $('trigger-assessment').item.json.email,\n  workflow_name: 'High Assessment Score Follow-up',\n  channel: 'email',\n  subject: 'Great score! Here's your next step',\n  status: 'sent',\n  sent_at: new Date().toISOString()\n} }}"
      },
      "id": "log-outreach",
      "name": "Log to Outreach Log",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2050, 200]
    }
  ],
  "connections": {
    "Webhook - New Assessment (Score >= 80)": {
      "main": [[{"node": "Check Score >= 80", "type": "main", "index": 0}]]
    },
    "Check Score >= 80": {
      "main": [
        [{"node": "Check Corporate Email", "type": "main", "index": 0}],
        []
      ]
    },
    "Check Corporate Email": {
      "main": [
        [{"node": "Apollo Enrich Person", "type": "main", "index": 0}],
        []
      ]
    },
    "Apollo Enrich Person": {
      "main": [[{"node": "Update Assessment with Enrichment", "type": "main", "index": 0}]]
    },
    "Update Assessment with Enrichment": {
      "main": [[{"node": "Check Hot Lead (Director+ & 500+)", "type": "main", "index": 0}]]
    },
    "Check Hot Lead (Director+ & 500+)": {
      "main": [
        [{"node": "Send Slack Alert", "type": "main", "index": 0}],
        []
      ]
    },
    "Send Slack Alert": {
      "main": [[{"node": "Search Apollo Lookalikes", "type": "main", "index": 0}]]
    },
    "Search Apollo Lookalikes": {
      "main": [[{"node": "Save Lookalikes to DB", "type": "main", "index": 0}]]
    },
    "Save Lookalikes to DB": {
      "main": [[{"node": "Send Email via SendGrid", "type": "main", "index": 0}]]
    },
    "Send Email via SendGrid": {
      "main": [[{"node": "Log to Outreach Log", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {"executionOrder": "v1"},
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-19T00:00:00.000Z",
  "versionId": "1"
}
